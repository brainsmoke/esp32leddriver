#include <stdlib.h>
#include <string.h>
#include "stm32f0xx.h"

#include "ws2801par.h"
#include "util.h"

typedef struct
{
	transposed_t transpose[N_VALUES_PER_STRIP];
	uint8_t low_bytes[N_VALUES];

} frame_t;

frame_t frame_a, frame_b;

uint8_t residual[N_VALUES];
frame_t * volatile cur;
frame_t * volatile next;

#define RECV_BUF_SZ (2048)
volatile uint8_t recv_buf[RECV_BUF_SZ];

#define O(c) (1<<(2*c))
#define ALT_FN(c) (2<<(2*c))
#define SWD (ALT_FN(13)|ALT_FN(14))

/*
# emulate original single strip order expected by software
facet_order = [
    21,22, 1,19,15,16,17,18, 2, 6, 7, 8, 9, 5, 3,
    52,53,54,50,51, 4,12,13,14,10,11, 0,23,24,20,
    34,30,44,35,36,37,38,39,40,49,45,46,47,48,41,
    59,55,56,57,58,42,26,27,28,29,25,43,31,32,33
]

led_order = [ f*5+l for f in facet_order for l in range(5) ]

byte_order = [ l*3+c for l in led_order for c in (1,0,2) ]

n_strips = 12
n_leds_per_strip = len(byte_order)//n_strips
n_values = n_strips*n_leds_per_strip
assert len(byte_order) == n_values

*/
static const uint16_t low_byte_index[] = 
{
/*

# byte 0 strip 0, byte 0 strip 1, ...
scattered = [ None ] * n_values

for i in range(len(byte_order)):
    scattered[i] = byte_order[(i%n_leds_per_strip)*n_strips + i//n_leds_per_strip]

for line in range(0, n_values, 16):
    print("\t" + ''.join('{:4d},'.format(n) for n in scattered[line:line+16]))
*/
	 316, 328, 340,  22, 289, 226, 238, 250, 262, 274,  31,  43, 100, 112, 124, 136,
	 148,  85,  52, 784, 796, 808, 820, 757, 769,  61,  73, 190, 202, 214, 151, 163,
	 175,   7, 349, 361, 373, 310, 517, 454, 661, 673, 535, 547, 559, 571, 583, 595,
	 607, 739, 676, 688, 700, 712, 724, 616, 628, 895, 832, 844, 856, 868, 880, 637,
	 394, 406, 418, 430, 442, 379, 646, 658, 475, 487, 499, 315, 327, 339,  21, 288,
	 225, 237, 249, 261, 273,  30,  42,  99, 111, 123, 135, 147,  84,  51, 783, 795,
	 807, 819, 756, 768,  60,  72, 189, 201, 213, 150, 162, 174,   6, 348, 360, 372,
	 309, 516, 453, 660, 672, 534, 546, 558, 570, 582, 594, 606, 738, 675, 687, 699,
	 711, 723, 615, 627, 894, 831, 843, 855, 867, 879, 636, 393, 405, 417, 429, 441,
	 378, 645, 657, 474, 486, 498, 317, 329, 341,  23, 290, 227, 239, 251, 263, 275,
	  32,  44, 101, 113, 125, 137, 149,  86,  53, 785, 797, 809, 821, 758, 770,  62,
	  74, 191, 203, 215, 152, 164, 176,   8, 350, 362, 374, 311, 518, 455, 662, 674,
	 536, 548, 560, 572, 584, 596, 608, 740, 677, 689, 701, 713, 725, 617, 629, 896,
	 833, 845, 857, 869, 881, 638, 395, 407, 419, 431, 443, 380, 647, 659, 476, 488,
	 500, 319, 331, 343,  25, 292, 229, 241, 253, 265, 277,  34,  91, 103, 115, 127,
	 139,  76,  88,  55, 787, 799, 811, 823, 760, 772,  64, 181, 193, 205, 217, 154,
	 166, 178,  10, 352, 364, 301, 313, 520, 457, 664, 526, 538, 550, 562, 574, 586,
	 598, 610, 742, 679, 691, 703, 715, 727, 619, 886, 898, 835, 847, 859, 871, 883,
	 640, 397, 409, 421, 433, 445, 382, 649, 466, 478, 490, 502, 318, 330, 342,  24,
	 291, 228, 240, 252, 264, 276,  33,  90, 102, 114, 126, 138,  75,  87,  54, 786,
	 798, 810, 822, 759, 771,  63, 180, 192, 204, 216, 153, 165, 177,   9, 351, 363,
	 300, 312, 519, 456, 663, 525, 537, 549, 561, 573, 585, 597, 609, 741, 678, 690,
	 702, 714, 726, 618, 885, 897, 834, 846, 858, 870, 882, 639, 396, 408, 420, 432,
	 444, 381, 648, 465, 477, 489, 501, 320, 332, 344,  26, 293, 230, 242, 254, 266,
	 278,  35,  92, 104, 116, 128, 140,  77,  89,  56, 788, 800, 812, 824, 761, 773,
	  65, 182, 194, 206, 218, 155, 167, 179,  11, 353, 365, 302, 314, 521, 458, 665,
	 527, 539, 551, 563, 575, 587, 599, 611, 743, 680, 692, 704, 716, 728, 620, 887,
	 899, 836, 848, 860, 872, 884, 641, 398, 410, 422, 434, 446, 383, 650, 467, 479,
	 491, 503, 322, 334,  16,  28, 295, 232, 244, 256, 268, 280,  37,  94, 106, 118,
	 130, 142,  79,  46,  58, 790, 802, 814, 751, 763, 775,  67, 184, 196, 208, 220,
	 157, 169,   1,  13, 355, 367, 304, 511, 523, 460, 667, 529, 541, 553, 565, 577,
	 589, 601, 613, 745, 682, 694, 706, 718, 730, 622, 889, 826, 838, 850, 862, 874,
	 631, 643, 400, 412, 424, 436, 448, 385, 652, 469, 481, 493, 505, 321, 333,  15,
	  27, 294, 231, 243, 255, 267, 279,  36,  93, 105, 117, 129, 141,  78,  45,  57,
	 789, 801, 813, 750, 762, 774,  66, 183, 195, 207, 219, 156, 168,   0,  12, 354,
	 366, 303, 510, 522, 459, 666, 528, 540, 552, 564, 576, 588, 600, 612, 744, 681,
	 693, 705, 717, 729, 621, 888, 825, 837, 849, 861, 873, 630, 642, 399, 411, 423,
	 435, 447, 384, 651, 468, 480, 492, 504, 323, 335,  17,  29, 296, 233, 245, 257,
	 269, 281,  38,  95, 107, 119, 131, 143,  80,  47,  59, 791, 803, 815, 752, 764,
	 776,  68, 185, 197, 209, 221, 158, 170,   2,  14, 356, 368, 305, 512, 524, 461,
	 668, 530, 542, 554, 566, 578, 590, 602, 614, 746, 683, 695, 707, 719, 731, 623,
	 890, 827, 839, 851, 863, 875, 632, 644, 401, 413, 425, 437, 449, 386, 653, 470,
	 482, 494, 506, 325, 337,  19, 286, 298, 235, 247, 259, 271, 283,  40,  97, 109,
	 121, 133, 145,  82,  49, 781, 793, 805, 817, 754, 766, 778,  70, 187, 199, 211,
	 223, 160, 172,   4, 346, 358, 370, 307, 514, 451, 463, 670, 532, 544, 556, 568,
	 580, 592, 604, 736, 748, 685, 697, 709, 721, 733, 625, 892, 829, 841, 853, 865,
	 877, 634, 391, 403, 415, 427, 439, 376, 388, 655, 472, 484, 496, 508, 324, 336,
	  18, 285, 297, 234, 246, 258, 270, 282,  39,  96, 108, 120, 132, 144,  81,  48,
	 780, 792, 804, 816, 753, 765, 777,  69, 186, 198, 210, 222, 159, 171,   3, 345,
	 357, 369, 306, 513, 450, 462, 669, 531, 543, 555, 567, 579, 591, 603, 735, 747,
	 684, 696, 708, 720, 732, 624, 891, 828, 840, 852, 864, 876, 633, 390, 402, 414,
	 426, 438, 375, 387, 654, 471, 483, 495, 507, 326, 338,  20, 287, 299, 236, 248,
	 260, 272, 284,  41,  98, 110, 122, 134, 146,  83,  50, 782, 794, 806, 818, 755,
	 767, 779,  71, 188, 200, 212, 224, 161, 173,   5, 347, 359, 371, 308, 515, 452,
	 464, 671, 533, 545, 557, 569, 581, 593, 605, 737, 749, 686, 698, 710, 722, 734,
	 626, 893, 830, 842, 854, 866, 878, 635, 392, 404, 416, 428, 440, 377, 389, 656,
	 473, 485, 497, 509,
};

static const uint8_t high_byte_index[] = 
{
/*
for line in range(0, n_values, 25):
    print("\t" + ''.join('{:2d},'.format(n//12) for n in scattered[line:line+25]))
*/
        26,27,28, 1,24,18,19,20,21,22, 2, 3, 8, 9,10,11,12, 7, 4,65,66,67,68,63,64,
         5, 6,15,16,17,12,13,14, 0,29,30,31,25,43,37,55,56,44,45,46,47,48,49,50,61,
        56,57,58,59,60,51,52,74,69,70,71,72,73,53,32,33,34,35,36,31,53,54,39,40,41,
        26,27,28, 1,24,18,19,20,21,22, 2, 3, 8, 9,10,11,12, 7, 4,65,66,67,68,63,64,
         5, 6,15,16,17,12,13,14, 0,29,30,31,25,43,37,55,56,44,45,46,47,48,49,50,61,
        56,57,58,59,60,51,52,74,69,70,71,72,73,53,32,33,34,35,36,31,53,54,39,40,41,
        26,27,28, 1,24,18,19,20,21,22, 2, 3, 8, 9,10,11,12, 7, 4,65,66,67,68,63,64,
         5, 6,15,16,17,12,13,14, 0,29,30,31,25,43,37,55,56,44,45,46,47,48,49,50,61,
        56,57,58,59,60,51,52,74,69,70,71,72,73,53,32,33,34,35,36,31,53,54,39,40,41,
        26,27,28, 2,24,19,20,21,22,23, 2, 7, 8, 9,10,11, 6, 7, 4,65,66,67,68,63,64,
         5,15,16,17,18,12,13,14, 0,29,30,25,26,43,38,55,43,44,45,46,47,48,49,50,61,
        56,57,58,59,60,51,73,74,69,70,71,72,73,53,33,34,35,36,37,31,54,38,39,40,41,
        26,27,28, 2,24,19,20,21,22,23, 2, 7, 8, 9,10,11, 6, 7, 4,65,66,67,68,63,64,
         5,15,16,17,18,12,13,14, 0,29,30,25,26,43,38,55,43,44,45,46,47,48,49,50,61,
        56,57,58,59,60,51,73,74,69,70,71,72,73,53,33,34,35,36,37,31,54,38,39,40,41,
        26,27,28, 2,24,19,20,21,22,23, 2, 7, 8, 9,10,11, 6, 7, 4,65,66,67,68,63,64,
         5,15,16,17,18,12,13,14, 0,29,30,25,26,43,38,55,43,44,45,46,47,48,49,50,61,
        56,57,58,59,60,51,73,74,69,70,71,72,73,53,33,34,35,36,37,31,54,38,39,40,41,
        26,27, 1, 2,24,19,20,21,22,23, 3, 7, 8, 9,10,11, 6, 3, 4,65,66,67,62,63,64,
         5,15,16,17,18,13,14, 0, 1,29,30,25,42,43,38,55,44,45,46,47,48,49,50,51,62,
        56,57,58,59,60,51,74,68,69,70,71,72,52,53,33,34,35,36,37,32,54,39,40,41,42,
        26,27, 1, 2,24,19,20,21,22,23, 3, 7, 8, 9,10,11, 6, 3, 4,65,66,67,62,63,64,
         5,15,16,17,18,13,14, 0, 1,29,30,25,42,43,38,55,44,45,46,47,48,49,50,51,62,
        56,57,58,59,60,51,74,68,69,70,71,72,52,53,33,34,35,36,37,32,54,39,40,41,42,
        26,27, 1, 2,24,19,20,21,22,23, 3, 7, 8, 9,10,11, 6, 3, 4,65,66,67,62,63,64,
         5,15,16,17,18,13,14, 0, 1,29,30,25,42,43,38,55,44,45,46,47,48,49,50,51,62,
        56,57,58,59,60,51,74,68,69,70,71,72,52,53,33,34,35,36,37,32,54,39,40,41,42,
        27,28, 1,23,24,19,20,21,22,23, 3, 8, 9,10,11,12, 6, 4,65,66,67,68,62,63,64,
         5,15,16,17,18,13,14, 0,28,29,30,25,42,37,38,55,44,45,46,47,48,49,50,61,62,
        57,58,59,60,61,52,74,69,70,71,72,73,52,32,33,34,35,36,31,32,54,39,40,41,42,
        27,28, 1,23,24,19,20,21,22,23, 3, 8, 9,10,11,12, 6, 4,65,66,67,68,62,63,64,
         5,15,16,17,18,13,14, 0,28,29,30,25,42,37,38,55,44,45,46,47,48,49,50,61,62,
        57,58,59,60,61,52,74,69,70,71,72,73,52,32,33,34,35,36,31,32,54,39,40,41,42,
        27,28, 1,23,24,19,20,21,22,23, 3, 8, 9,10,11,12, 6, 4,65,66,67,68,62,63,64,
         5,15,16,17,18,13,14, 0,28,29,30,25,42,37,38,55,44,45,46,47,48,49,50,61,62,
        57,58,59,60,61,52,74,69,70,71,72,73,52,32,33,34,35,36,31,32,54,39,40,41,42,
};

#define P0 (1<<1)
#define P1 (1<<2)
#define P2 (1<<3)
#define P3 (1<<4)
#define P4 (1<<5)
#define P5 (1<<6)
#define P6 (1<<8)
#define P7 (1<<9)
#define P8 (1<<11)
#define P9 (1<<12)
#define PA (1<<13)
#define PB (1<<14)

static const uint16_t high_byte_pin[] =
{
/*
for line in range(0, n_values, 25):
    print("\t" + ''.join('P{:X},'.format(n%12) for n in scattered[line:line+25]))
*/
	P4,P4,P4,PA,P1,PA,PA,PA,PA,PA,P7,P7,P4,P4,P4,P4,P4,P1,P4,P4,P4,P4,P4,P1,P1,
	P1,P1,PA,PA,PA,P7,P7,P7,P7,P1,P1,P1,PA,P1,PA,P1,P1,P7,P7,P7,P7,P7,P7,P7,P7,
	P4,P4,P4,P4,P4,P4,P4,P7,P4,P4,P4,P4,P4,P1,PA,PA,PA,PA,PA,P7,PA,PA,P7,P7,P7,
	P3,P3,P3,P9,P0,P9,P9,P9,P9,P9,P6,P6,P3,P3,P3,P3,P3,P0,P3,P3,P3,P3,P3,P0,P0,
	P0,P0,P9,P9,P9,P6,P6,P6,P6,P0,P0,P0,P9,P0,P9,P0,P0,P6,P6,P6,P6,P6,P6,P6,P6,
	P3,P3,P3,P3,P3,P3,P3,P6,P3,P3,P3,P3,P3,P0,P9,P9,P9,P9,P9,P6,P9,P9,P6,P6,P6,
	P5,P5,P5,PB,P2,PB,PB,PB,PB,PB,P8,P8,P5,P5,P5,P5,P5,P2,P5,P5,P5,P5,P5,P2,P2,
	P2,P2,PB,PB,PB,P8,P8,P8,P8,P2,P2,P2,PB,P2,PB,P2,P2,P8,P8,P8,P8,P8,P8,P8,P8,
	P5,P5,P5,P5,P5,P5,P5,P8,P5,P5,P5,P5,P5,P2,PB,PB,PB,PB,PB,P8,PB,PB,P8,P8,P8,
	P7,P7,P7,P1,P4,P1,P1,P1,P1,P1,PA,P7,P7,P7,P7,P7,P4,P4,P7,P7,P7,P7,P7,P4,P4,
	P4,P1,P1,P1,P1,PA,PA,PA,PA,P4,P4,P1,P1,P4,P1,P4,PA,PA,PA,PA,PA,PA,PA,PA,PA,
	P7,P7,P7,P7,P7,P7,PA,PA,P7,P7,P7,P7,P7,P4,P1,P1,P1,P1,P1,PA,P1,PA,PA,PA,PA,
	P6,P6,P6,P0,P3,P0,P0,P0,P0,P0,P9,P6,P6,P6,P6,P6,P3,P3,P6,P6,P6,P6,P6,P3,P3,
	P3,P0,P0,P0,P0,P9,P9,P9,P9,P3,P3,P0,P0,P3,P0,P3,P9,P9,P9,P9,P9,P9,P9,P9,P9,
	P6,P6,P6,P6,P6,P6,P9,P9,P6,P6,P6,P6,P6,P3,P0,P0,P0,P0,P0,P9,P0,P9,P9,P9,P9,
	P8,P8,P8,P2,P5,P2,P2,P2,P2,P2,PB,P8,P8,P8,P8,P8,P5,P5,P8,P8,P8,P8,P8,P5,P5,
	P5,P2,P2,P2,P2,PB,PB,PB,PB,P5,P5,P2,P2,P5,P2,P5,PB,PB,PB,PB,PB,PB,PB,PB,PB,
	P8,P8,P8,P8,P8,P8,PB,PB,P8,P8,P8,P8,P8,P5,P2,P2,P2,P2,P2,PB,P2,PB,PB,PB,PB,
	PA,PA,P4,P4,P7,P4,P4,P4,P4,P4,P1,PA,PA,PA,PA,PA,P7,PA,PA,PA,PA,PA,P7,P7,P7,
	P7,P4,P4,P4,P4,P1,P1,P1,P1,P7,P7,P4,P7,P7,P4,P7,P1,P1,P1,P1,P1,P1,P1,P1,P1,
	PA,PA,PA,PA,PA,PA,P1,PA,PA,PA,PA,PA,P7,P7,P4,P4,P4,P4,P4,P1,P4,P1,P1,P1,P1,
	P9,P9,P3,P3,P6,P3,P3,P3,P3,P3,P0,P9,P9,P9,P9,P9,P6,P9,P9,P9,P9,P9,P6,P6,P6,
	P6,P3,P3,P3,P3,P0,P0,P0,P0,P6,P6,P3,P6,P6,P3,P6,P0,P0,P0,P0,P0,P0,P0,P0,P0,
	P9,P9,P9,P9,P9,P9,P0,P9,P9,P9,P9,P9,P6,P6,P3,P3,P3,P3,P3,P0,P3,P0,P0,P0,P0,
	PB,PB,P5,P5,P8,P5,P5,P5,P5,P5,P2,PB,PB,PB,PB,PB,P8,PB,PB,PB,PB,PB,P8,P8,P8,
	P8,P5,P5,P5,P5,P2,P2,P2,P2,P8,P8,P5,P8,P8,P5,P8,P2,P2,P2,P2,P2,P2,P2,P2,P2,
	PB,PB,PB,PB,PB,PB,P2,PB,PB,PB,PB,PB,P8,P8,P5,P5,P5,P5,P5,P2,P5,P2,P2,P2,P2,
	P1,P1,P7,PA,PA,P7,P7,P7,P7,P7,P4,P1,P1,P1,P1,P1,PA,P1,P1,P1,P1,P1,PA,PA,PA,
	PA,P7,P7,P7,P7,P4,P4,P4,PA,PA,PA,P7,PA,P7,P7,PA,P4,P4,P4,P4,P4,P4,P4,P4,P4,
	P1,P1,P1,P1,P1,P1,P4,P1,P1,P1,P1,P1,PA,P7,P7,P7,P7,P7,P4,P4,P7,P4,P4,P4,P4,
	P0,P0,P6,P9,P9,P6,P6,P6,P6,P6,P3,P0,P0,P0,P0,P0,P9,P0,P0,P0,P0,P0,P9,P9,P9,
	P9,P6,P6,P6,P6,P3,P3,P3,P9,P9,P9,P6,P9,P6,P6,P9,P3,P3,P3,P3,P3,P3,P3,P3,P3,
	P0,P0,P0,P0,P0,P0,P3,P0,P0,P0,P0,P0,P9,P6,P6,P6,P6,P6,P3,P3,P6,P3,P3,P3,P3,
	P2,P2,P8,PB,PB,P8,P8,P8,P8,P8,P5,P2,P2,P2,P2,P2,PB,P2,P2,P2,P2,P2,PB,PB,PB,
	PB,P8,P8,P8,P8,P5,P5,P5,PB,PB,PB,P8,PB,P8,P8,PB,P5,P5,P5,P5,P5,P5,P5,P5,P5,
	P2,P2,P2,P2,P2,P2,P5,P2,P2,P2,P2,P2,PB,P8,P8,P8,P8,P8,P5,P5,P8,P5,P5,P5,P5,
};

void SysTick_Handler(void)
{
	precomp_dithering(cur->transpose, cur->low_bytes, residual, N_VALUES_PER_STRIP);
	bitbang_ws2801(cur->transpose, N_VALUES_PER_STRIP, CLK_MASK, GPIOB);
}

static void init(void)
{
	int i;
	for (i=0; i<N_VALUES; i++)
		residual[i] = i*153;
	cur = &frame_a;
	next = &frame_b;
	clock48mhz();
	RCC->AHBENR |= RCC_AHBENR_GPIOAEN | RCC_AHBENR_GPIOBEN; 	// enable the clock to GPIOA
	GPIOA->ODR = 0;
	GPIOA->MODER = SWD;

	GPIOA->ODR = 0;
	GPIOB->MODER = O(0)|O(1)|O(2)|O(3)|O(4)|O(5)|O(6)|O(7)|O(9)|O(9)|O(10)|O(11)|O(12)|O(13)|O(14)|O(15);

	usart1_rx_pa10_dma3_enable(recv_buf, RECV_BUF_SZ, 48e6/2e6);
	enable_sys_tick(SYS_TICK_FRAMERATE);
}

static volatile uint8_t *recv_p=recv_buf, *recv_end=recv_buf;

static void dma_wait(void)
{
	if (recv_p == &recv_buf[RECV_BUF_SZ])
		recv_p = recv_end = &recv_buf[0];

	while(recv_p == recv_end)
	{
		recv_end = &recv_buf[RECV_BUF_SZ-DMA1_Channel3->CNDTR];
		if (recv_p > recv_end)
			recv_end = &recv_buf[RECV_BUF_SZ];
	}	
}

enum
{
	GOOD,
	GOOD_00,
	GOOD_01_FE,
	GOOD_FF,
	GOOD_FFFF,
	GOOD_FFFFFF,
	BAD,
	BAD_FF,
	BAD_FFFF,
	BAD_FFFFFF,

	STATE_COUNT,

	GOOD_RETURN,
	BAD_RETURN,
};

enum
{
	IN_00,
	IN_01_EF,
	IN_F0,
	IN_F1_FE,
	IN_FF,
};

static const uint8_t fsm[STATE_COUNT][8] =
{
	[GOOD]        = {  [IN_00] = GOOD_00, [IN_01_EF] = GOOD_01_FE, [IN_F0] = GOOD_01_FE , [IN_F1_FE] = GOOD_01_FE, [IN_FF] = GOOD_FF      , },
	[GOOD_00]     = {  [IN_00] = GOOD   , [IN_01_EF] = GOOD      , [IN_F0] = GOOD       , [IN_F1_FE] = GOOD      , [IN_FF] = GOOD         , },
	[GOOD_01_FE]  = {  [IN_00] = GOOD   , [IN_01_EF] = GOOD      , [IN_F0] = GOOD       , [IN_F1_FE] = GOOD      , [IN_FF] = BAD_FF       , },
	[GOOD_FF]     = {  [IN_00] = GOOD   , [IN_01_EF] = GOOD      , [IN_F0] = GOOD       , [IN_F1_FE] = GOOD      , [IN_FF] = GOOD_FFFF    , },
	[GOOD_FFFF]   = {  [IN_00] = BAD    , [IN_01_EF] = BAD       , [IN_F0] = BAD        , [IN_F1_FE] = BAD       , [IN_FF] = GOOD_FFFFFF  , },
	[GOOD_FFFFFF] = {  [IN_00] = BAD    , [IN_01_EF] = BAD       , [IN_F0] = GOOD_RETURN, [IN_F1_FE] = BAD       , [IN_FF] = BAD_FFFFFF   , },
	[BAD]         = {  [IN_00] = BAD    , [IN_01_EF] = BAD       , [IN_F0] = BAD        , [IN_F1_FE] = BAD       , [IN_FF] = BAD_FF       , },
	[BAD_FF]      = {  [IN_00] = BAD    , [IN_01_EF] = BAD       , [IN_F0] = BAD        , [IN_F1_FE] = BAD       , [IN_FF] = BAD_FFFF     , },
	[BAD_FFFF]    = {  [IN_00] = BAD    , [IN_01_EF] = BAD       , [IN_F0] = BAD        , [IN_F1_FE] = BAD       , [IN_FF] = BAD_FFFFFF   , },
	[BAD_FFFFFF]  = {  [IN_00] = BAD    , [IN_01_EF] = BAD       , [IN_F0] = BAD_RETURN , [IN_F1_FE] = BAD       , [IN_FF] = BAD_FFFFFF   , },

};

static int read_next_frame(void)
{
	int i, c;

	memset(next, 0, sizeof(frame_t));

	for(i=0; i<N_VALUES; i++)
	{
		if (recv_p == recv_end)
			dma_wait();

		c = *recv_p++;
		next->low_bytes[low_byte_index[i]] = c;

		if (recv_p == recv_end)
			dma_wait();

		c |= (*recv_p++)<<8;

		if (c > 0xff00)
			break;

		c >>= 8;

		transposed_t *t = &next->transpose[high_byte_index[i]];
		int pin = high_byte_pin[i];
		write_value(t, pin, c);
/*
		if (c & 0x01)
			t->bit0 |= pin;
		if (c & 0x02)
			t->bit1 |= pin;
		if (c & 0x04)
			t->bit2 |= pin;
		if (c & 0x08)
			t->bit3 |= pin;
		if (c & 0x10)
			t->bit4 |= pin;
		if (c & 0x20)
			t->bit5 |= pin;
		if (c & 0x40)
			t->bit6 |= pin;
		if (c & 0x80)
			t->bit7 |= pin;
*/
	}

	int s=GOOD;

	if (c == 0xffff)
		s = GOOD_FFFF;
	else if (c > 0xff00)
		s = BAD_FF;

	for(;;)
	{
		if (recv_p == recv_end)
			dma_wait();

		c = *recv_p++;

		if (c == 0)
			i = IN_00;
		else if (c < 0xf0)
			i = IN_01_EF;
		else if (c == 0xf0)
			i = IN_F0;
		else if (c == 0xff)
			i = IN_FF;
		else
			i = IN_F1_FE;

		s = fsm[s][i];

		if (s == GOOD_RETURN)
			return 1;
		else if (s == BAD_RETURN)
			return 0;
	}
}

int main(void)
{
	init();
	for(;;)
	{
		frame_t *tmp = cur;
		cur = next; /* swap is not atomic, but only the assignment of cur needs to be */
		next = tmp;
		while (! read_next_frame() );
	}
}

